<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Resultado del Modelo</title>
    <!-- Tema de Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.1.3/dist/flatly/bootstrap.min.css" />
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
</head>
<body class="p-4">
    <!-- Contenedor principal de resultados -->
    <div class="container container-box">
        <h1>Modelo seleccionado: {{ model_name }}</h1>
        <h3 class="mt-4">Series de valores</h3>
        <p><strong>Entrenamiento:</strong> {{ train_display }}</p>
        <p><strong>Reales (test):</strong> {{ test_display }}</p>
        <p><strong>Pronosticados:</strong> {{ pred_display }}</p>
        <!-- Canvas donde se dibujará el gráfico con Chart.js -->
        <canvas id="chart" height="100"></canvas>
        <!-- Formulario para descargar los datos en Excel -->
        <form method="POST" action="{{ url_for('download_excel') }}" class="mt-3">
            <input type="hidden" name="model_name" value="{{ model_name }}" />
            <input type="hidden" name="train_series" value='{{ train_series|tojson }}' />
            <input type="hidden" name="test_series" value='{{ test_series|tojson }}' />
            <input type="hidden" name="pred_series" value='{{ pred_series|tojson }}' />
            <input type="hidden" name="dates" value='{{ dates|tojson }}' />
            <button type="submit" class="btn btn-primary">Guardar en Excel</button>
        </form>
    </div>
    <!-- Bibliotecas JavaScript y script para dibujar el gráfico -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const labels = {{ dates|tojson }};
        const train = {{ train_series|tojson }};
        const testReal = {{ test_series|tojson }};
        const testPred = {{ pred_series|tojson }};
        const ciLower = {{ ci_lower|tojson }};
        const ciUpper = {{ ci_upper|tojson }};
        const hasCI = {{ 'true' if has_confidence_data else 'false' }};

        // Configura y renderiza el gráfico de líneas con las tres series
        const datasets = [
            {
                label: 'Entrenamiento',
                data: train,
                borderColor: 'rgba(0, 123, 255, 0.9)',
                fill: false,
                pointRadius: 0,
                spanGaps: true
            },
            {
                label: 'Real (test)',
                data: testReal,
                borderColor: 'rgba(40, 167, 69, 0.9)',
                fill: false,
                pointRadius: 0,
                spanGaps: true
            },
            {
                label: 'Pronóstico',
                data: testPred,
                borderColor: 'rgba(220, 53, 69, 0.9)',
                fill: false,
                pointRadius: 3,
                tension: 0.2,
                spanGaps: true
            }
        ];

        if (hasCI) {
            const ciLineColor = 'rgba(220, 53, 69, 0.55)';
            const ciFillColor = 'rgba(220, 53, 69, 0.15)';
            datasets.push(
                {
                    label: 'IC Superior',
                    data: ciUpper,
                    borderColor: ciLineColor,
                    backgroundColor: ciFillColor,
                    pointRadius: 0,
                    borderDash: [6, 4],
                    fill: false,
                    borderWidth: 1,
                    spanGaps: true,
                    order: 0
                },
                {
                    label: 'IC Inferior',
                    data: ciLower,
                    borderColor: ciLineColor,
                    backgroundColor: ciFillColor,
                    pointRadius: 0,
                    borderDash: [6, 4],
                    borderWidth: 1,
                    fill: '-1',
                    spanGaps: true,
                    order: 0
                }
            );
        }

        new Chart(document.getElementById('chart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        labels: {
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                if (label.startsWith('IC')) {
                                    return `${label}: ${context.parsed.y !== null ? context.parsed.y.toFixed(4) : 'N/A'}`;
                                }
                                return `${label}: ${context.parsed.y !== null ? context.parsed.y.toFixed(4) : 'N/A'}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0
                        }
                    },
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
    </script>
</body>
</html>
