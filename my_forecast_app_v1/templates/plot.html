<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Resultado del Modelo</title>
    <!-- Tema de Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.1.3/dist/flatly/bootstrap.min.css" />
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
</head>
<body class="p-4">
    <!-- Contenedor principal de resultados -->
    <div class="container container-box">
        <h1>Modelo seleccionado: {{ model_name }}</h1>
        <h3 class="mt-4">Series de valores</h3>
        <p><strong>Entrenamiento:</strong> {{ train_display }}</p>
        <p><strong>Reales (test):</strong> {{ test_display }}</p>
        <p><strong>Pronosticados:</strong> {{ pred_display }}</p>
        {% if forecast_series %}
        <p><strong>Pronóstico futuro:</strong> {{ forecast_display }}</p>
        {% endif %}
        <!-- Canvas donde se dibujará el gráfico con Chart.js -->
        <canvas id="chart" height="100"></canvas>
        <!-- Formulario para descargar los datos en Excel -->
        <form method="POST" action="{{ url_for('download_excel') }}" class="mt-3">
            <input type="hidden" name="model_name" value="{{ model_name }}" />
            <input type="hidden" name="train_series" value='{{ train_series|tojson }}' />
            <input type="hidden" name="test_series" value='{{ test_series|tojson }}' />
            <input type="hidden" name="pred_series" value='{{ pred_series|tojson }}' />
            <input type="hidden" name="dates" value='{{ dates|tojson }}' />
            <button type="submit" class="btn btn-primary">Guardar en Excel</button>
        </form>
    </div>
    <!-- Bibliotecas JavaScript y script para dibujar el gráfico -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const historicalLabels = {{ dates|tojson }};
        const futureLabels = {{ future_dates|tojson }};
        const labels = historicalLabels.concat(futureLabels);

        const train = {{ train_series|tojson }};
        const testReal = {{ test_series|tojson }};
        const testPred = {{ pred_series|tojson }};
        const forecastFuture = {{ forecast_series|tojson }};
        const forecastLower = {{ forecast_lower|tojson }};
        const forecastUpper = {{ forecast_upper|tojson }};

        const forecastPadding = Array(historicalLabels.length).fill(null);
        const extension = Array(futureLabels.length).fill(null);

        const trainPlot = train.concat(extension);
        const testPlot = testReal.concat(extension);
        const predPlot = testPred.concat(extension);
        const forecastPlot = forecastPadding.concat(forecastFuture);
        const lowerPlot = forecastPadding.concat(forecastLower);
        const upperPlot = forecastPadding.concat(forecastUpper);

        // Configura y renderiza el gráfico de líneas con todas las series
        new Chart(document.getElementById('chart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Entrenamiento',
                        data: trainPlot,
                        borderColor: 'blue',
                        fill: false,
                        spanGaps: true
                    },
                    {
                        label: 'Real (test)',
                        data: testPlot,
                        borderColor: 'green',
                        fill: false,
                        spanGaps: true
                    },
                    {
                        label: 'Pronóstico (test)',
                        data: predPlot,
                        borderColor: 'red',
                        fill: false,
                        spanGaps: true
                    },
                    {
                        label: 'Pronóstico futuro',
                        data: forecastPlot,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderDash: [6, 6],
                        fill: false,
                        spanGaps: true
                    },
                    {
                        label: 'IC 95% inferior',
                        data: lowerPlot,
                        borderColor: 'rgba(255, 99, 132, 0.4)',
                        borderWidth: 1,
                        pointRadius: 0,
                        fill: false,
                        spanGaps: true
                    },
                    {
                        label: 'IC 95% superior',
                        data: upperPlot,
                        borderColor: 'rgba(255, 99, 132, 0.4)',
                        backgroundColor: 'rgba(255, 99, 132, 0.12)',
                        borderWidth: 1,
                        pointRadius: 0,
                        fill: {
                            target: '-1',
                            above: 'rgba(255, 99, 132, 0.12)',
                            below: 'rgba(255, 99, 132, 0.12)'
                        },
                        spanGaps: true
                    }
                ]
            }
        });
    </script>
</body>
</html>
